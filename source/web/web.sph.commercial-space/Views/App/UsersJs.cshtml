@using Newtonsoft.Json
@model Bespoke.Sph.Commerspace.Web.Controllers.AdminController
@{
    ViewBag.Title = "UsersJs";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var roles = Roles.GetAllRoles();
    
}

<script type="text/javascript" data-script="true">
    define(['services/datacontext','viewmodels/_users.designation','viewmodels/_users.department'], function (context,designationvm,departmentvm) {
        var isBusy = ko.observable(false),
            roles = @Html.Raw(JsonConvert.SerializeObject(roles)),
            profiles = ko.observableArray(),
            activate = function() {
                var query = String.format("UserProfileId gt 0");
                var tcs = new $.Deferred();
                loadDetails();
                var profileTask = context.loadAsync("UserProfile", query);
                var designationTask = context.getListAsync("Designation","DesignationId gt 0", "Name");
                var departmentTask = context.loadOneAsync("Setting", "Key eq 'Departments'");
                $.when(designationTask,profileTask,departmentTask)
                 .then(function(s,p,d) {
                     isBusy(false);
                     if (s) {
                         vm.designationOptions(s);
                     } 
                     if (d) {
                         var departments = JSON.parse(ko.mapping.toJS(d.Value));;
                         vm.departmentOptions(departments);
                     }
                     var list = _(p.itemCollection).map(function(item) {
                         var profile = new bespoke.sphcommercialspace.domain.Profile();
                         profile.IsNew(false);
                         profile.FullName(item.FullName());
                         profile.UserName(item.Username());
                         profile.Email(item.Email());
                         profile.Designation(item.Designation());
                         profile.Department(item.Department());
                         profile.Telephone(item.Telephone());
                         return profile;
                     });
                     vm.profiles(list);
                    
                     tcs.resolve(true);
                 });
                return tcs.promise();
            },
            loadDetails = function() {
                designationvm.activate(roles);
                departmentvm.activate();
            },
            add = function() {
                vm.profile(new bespoke.sphcommercialspace.domain.Profile());
                vm.profile().IsNew(true);
            },
            editedProfile = ko.observable(),
            edit = function(user) {
                editedProfile(user);
                var c1 = ko.mapping.fromJSON(ko.mapping.toJSON(user));
                var clone = c1;
                vm.profile(clone);
            },
            save = function() {
                var tcs = new $.Deferred();
                var data = ko.mapping.toJSON({profile : vm.profile}) ;
                isBusy(true);

                context.post(data, "/Admin/AddUser")
                    .then(function(result) {
                        isBusy(false);
                        vm.profiles.push(result);
                        tcs.resolve(true);
                    });
                return tcs.promise();
            };
            

        var vm = {
            activate: activate,
            isBusyValidatingUserName : ko.observable(false),
            profiles: profiles,
            profile: ko.observable(new bespoke.sphcommercialspace.domain.Profile()),
            designationOptions : ko.observableArray(),
            departmentOptions : ko.observableArray(),
            userNameValidationStatus : ko.observable(),
            addCommand: add,
            editCommand: edit,
            saveCommand: save
        };


        vm.profile().UserName.subscribe(function(username) {
            vm.isBusyValidatingUserName(true);
            var tcs = new $.Deferred();
            var data = JSON.stringify({userName : username});
            isBusy(true);
            context.post(data, "/Admin/ValidateUserName")
                .then(function(result) {
                    isBusy(false);
                    vm.isBusyValidatingUserName(false);
                    if (result.status !== "OK") {
                        vm.userNameValidationStatus(result.message);
                    }
                    
                    tcs.resolve(result);
                });
            return tcs.promise();
        });
        
        return vm;
    });
</script>
