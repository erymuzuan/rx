define([objectbuilders.datacontext,objectbuilders.logger,objectbuilders.router,"durandal/system",objectbuilders.config],function(n,t,i,r,u){var e=ko.observable(!1),o=ko.observable(),s=ko.observable(),h=ko.observable(new bespoke.sph.domain.RentalApplication),c=function(t){o(parseInt(t.spaceId));var i=parseInt(t.templateId),u=new $.Deferred,e=n.loadOneAsync("Space","SpaceId eq "+o()),s=n.loadOneAsync("Setting","Key eq 'State'");return $.when(e,s).done(function(n,t){var o=JSON.parse(ko.mapping.toJS(t.Value)),i,r,e;f.stateOptions(o);f.space(n);i=ko.observableArray();_.each(n.FeatureDefinitionCollection(),function(n){i.push(n.Category())});r=ko.observableArray();r(_.uniq(i()));e=_(r()).map(function(t){var i=_(n.FeatureDefinitionCollection()).filter(function(n){return n.Category()===t});return{category:t,features:i}});f.facilities(e);f.totalRate(n.RentalRate());u.resolve(!0)}),f.rentalapplication().SpaceId(t.id),n.loadOneAsync("ApplicationTemplate","ApplicationTemplateId eq "+i).done(function(n){var t=_(n.CustomFieldCollection()).map(function(n){var i=r.guid(),t=new bespoke.sph.domain.CustomFieldValue(i);return t.Name(n.Name()),t.Type(n.Type()),t});f.rentalapplication().CustomFieldValueCollection(t);f.rentalapplication().TemplateName(n.Name())}),f.rentalapplication().TemplateId(i),u.promise()},l=function(){},a=function(n,i,r){$(n).find("input[type=file]").kendoUpload({async:{saveUrl:"/BinaryStore/Upload",removeUrl:"/BinaryStore/Remove",autoUpload:!0},multiple:!1,error:function(n){t.logError(n,n,this,!0)},success:function(n){t.log("Your file has been uploaded",n,"route/create",!0);r.StoreId(n.response.storeId);r.IsReceived(n.operation==="upload")}})},v=function(){var r=new $.Deferred,o=ko.mapping.toJSON(f.rentalapplication());return e(!0),n.post(o,"/RentalApplication/Submit").done(function(n){if(t.log("Data has been successfully saved ",n,"rentalapplication",!0),e(!1),s(n.registrationNo),f.rentalapplication(new bespoke.sph.domain.RentalApplication),!u.isAuthenticated)$("#success-panel").modal({}).on("hidden",function(){i.navigateTo("/#/")});r.resolve(n.status)}),r.promise()},y=function(){var n=new bespoke.sph.domain.Attachment(r.guid());f.rentalapplication().AttachmentCollection.push(n)},p=function(n){f.rentalapplication().AttachmentCollection.remove(n)},w=function(n){var t=new bespoke.sph.domain.Feature,i,r;t.Name(n.Name());t.Occurence(n.Occurence());t.OccurenceTimeSpan(n.OccurenceTimeSpan());t.Quantity(n.AvailableQuantity());t.Charge(n.AvailableQuantity()*n.Charge());f.rentalapplication().FeatureCollection.push(t);i=f.space().RentalRate();r=_(f.rentalapplication().FeatureCollection()).reduce(function(n,t){return n+parseFloat(t.Charge())},0);f.totalRate(r+i)},b=function(n){f.rentalapplication().FeatureCollection.remove(n);var t=f.totalRate(),i=parseFloat(n.Charge());f.totalRate(t-i)},f={activate:c,registrationNo:s,viewAttached:l,configureUpload:a,stateOptions:ko.observableArray(),facilities:ko.observableArray(),availableQuantities:ko.observableArray(),rentalapplication:ko.observable(new bespoke.sph.domain.RentalApplication),space:ko.observable(new bespoke.sph.domain.Space),totalRate:ko.observable(),toolbar:{printCommand:ko.observable({entity:ko.observable("RentalApplication"),id:ko.observable(0),item:h}),commands:ko.observableArray([{caption:"Hantar Permohonan",icon:"icon-envelope",status:"none",command:v}])},isBusy:e,addAttachmentCommand:y,removeAttachmentCommand:p,addFeatureToList:w,removeFeatureFromList:b};return f});
//# sourceMappingURL=application.detail.min.js.map