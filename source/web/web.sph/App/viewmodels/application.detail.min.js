define([objectbuilders.datacontext,objectbuilders.logger,objectbuilders.router,"durandal/system",objectbuilders.config,objectbuilders.validation,objectbuilders.defaultValueProvider],function(n,t,i,r,u,f,e){var s=ko.observable(!1),h=ko.observable(),c=ko.observable(),l=ko.observable(),a=ko.observable(new bespoke.sph.domain.RentalApplication),v=function(t){h(parseInt(t.spaceId));var i=parseInt(t.templateId),u=new $.Deferred,f=n.loadOneAsync("Space","SpaceId eq "+h()),s=n.loadOneAsync("Setting","Key eq 'State'");return $.when(f,s).done(function(n,t){var e=JSON.parse(ko.mapping.toJS(t.Value)),i,r,f;o.stateOptions(e);o.space(n);i=ko.observableArray();_.each(n.FeatureDefinitionCollection(),function(n){i.push(n.Category())});r=ko.observableArray();r(_.uniq(i()));f=_(r()).map(function(t){var i=_(n.FeatureDefinitionCollection()).filter(function(n){return n.Category()===t});return{category:t,features:i}});o.facilities(f);o.totalRate(n.RentalRate());u.resolve(!0)}),o.rentalapplication().SpaceId(h()),n.loadOneAsync("ApplicationTemplate","ApplicationTemplateId eq "+i).done(function(n){c(n);e.setDefaultValues(o.rentalapplication(),n);var t=_(n.CustomFieldCollection()).map(function(n){var i=r.guid(),t=new bespoke.sph.domain.CustomFieldValue(i);return t.Name(n.Name()),t.Type(n.Type()),t});o.rentalapplication().CustomFieldValueCollection(t);o.rentalapplication().TemplateName(n.Name())}),e.setDefaultValues(o.building(),template),o.rentalapplication().TemplateId(i),u.promise()},y=function(){f.init($("#application-detail-form"),c())},p=function(n,i,r){$(n).find("input[type=file]").kendoUpload({async:{saveUrl:"/BinaryStore/Upload",removeUrl:"/BinaryStore/Remove",autoUpload:!0},multiple:!1,error:function(n){t.logError(n,n,this,!0)},success:function(n){t.log("Your file has been uploaded",n,"route/create",!0);r.StoreId(n.response.storeId);r.IsReceived(n.operation==="upload")}})},w=function(){if(!f.valid())return Task.fromResult(!1);var r=new $.Deferred,e=ko.mapping.toJSON(o.rentalapplication());return s(!0),n.post(e,"/RentalApplication/Submit").done(function(n){if(t.log("Data has been successfully saved ",n,"rentalapplication",!0),s(!1),l(n.registrationNo),o.rentalapplication(new bespoke.sph.domain.RentalApplication),!u.isAuthenticated)$("#success-panel").modal({}).on("hidden",function(){i.navigateTo("/#/")});r.resolve(n.status)}),r.promise()},b=function(){var n=new bespoke.sph.domain.Attachment(r.guid());o.rentalapplication().AttachmentCollection.push(n)},k=function(n){o.rentalapplication().AttachmentCollection.remove(n)},d=function(n){var t=new bespoke.sph.domain.Feature,i,r;t.Name(n.Name());t.Occurence(n.Occurence());t.OccurenceTimeSpan(n.OccurenceTimeSpan());t.Quantity(n.AvailableQuantity());t.Charge(n.AvailableQuantity()*n.Charge());o.rentalapplication().FeatureCollection.push(t);i=o.space().RentalRate();r=_(o.rentalapplication().FeatureCollection()).reduce(function(n,t){return n+parseFloat(t.Charge())},0);o.totalRate(r+i)},g=function(n){o.rentalapplication().FeatureCollection.remove(n);var t=o.totalRate(),i=parseFloat(n.Charge());o.totalRate(t-i)},o={activate:v,registrationNo:l,viewAttached:y,configureUpload:p,stateOptions:ko.observableArray(),facilities:ko.observableArray(),availableQuantities:ko.observableArray(),rentalapplication:ko.observable(new bespoke.sph.domain.RentalApplication),space:ko.observable(new bespoke.sph.domain.Space),totalRate:ko.observable(),toolbar:{printCommand:ko.observable({entity:ko.observable("RentalApplication"),id:ko.observable(0),item:a}),commands:ko.observableArray([{caption:"Hantar Permohonan",icon:"icon-envelope",status:"none",command:w}])},isBusy:s,addAttachmentCommand:b,removeAttachmentCommand:k,addFeatureToList:d,removeFeatureFromList:g};return o});
//# sourceMappingURL=application.detail.min.js.map