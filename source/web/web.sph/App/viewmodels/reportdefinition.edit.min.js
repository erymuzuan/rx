define(["services/datacontext","services/logger","durandal/system","./reportdefinition.base","./_reportdefinition.preview","services/jsonimportexport"],function(n,t,i,r,u,f){var c=ko.observable(!1),l=ko.observable(),s=function(n){_(n.ReportLayoutCollection()).each(function(n){_(n.ReportItemCollection()).each(function(n){n.isSelected=ko.observable(!1)})});e.reportDefinition(n);r.reportDefinition(n);u.activate(n);h(n.DataSource().EntityFieldCollection());n.DataSource().EntityName.subscribe(o)},a=function(t){var u,e,h,f;return(r.activate(),u=parseInt(t.id),l(u),u)?(h=String.format("ReportDefinitionId eq {0}",u),f=new $.Deferred,n.loadOneAsync("ReportDefinition",h).done(function(n){o(n.DataSource().EntityName()).done(function(){s(n);f.resolve(!0)})}),f.promise()):(e=new bespoke.sph.domain.ReportDefinition(i.guid()),s(e),!0)},v=function(n){r.viewAttached(n);$("a.btn-close-configuration-dialog").click(function(){h(e.reportDefinition().DataSource().EntityFieldCollection())})},h=function(n){var t=_(n).map(function(n){var i=n.Name(),t=n.Aggregate();return t&&t!=="GROUP"&&(i=n.Name()+"_"+t),"["+i+"]"}),i=_(n).map(function(n){var i=n.Name(),t=n.Aggregate();return t&&t!=="GROUP"&&(i=n.Name()+"_"+t),i});e.dataGridColumnOptions(t);e.columnOptions(i)},o=function(n){var t=new $.Deferred;return $.get("ReportDefinition/GetEntityColumns/"+n).done(function(n){e.entityColumns(n);var t=_(n).filter(function(n){return n.IsFilterable});e.filterableEntityColumns(t)}).done(t.resolve),t.promise()},y=function(){$(".report-layout").each(function(n,t){var i=_($(t).find(".report-item")).map(function(n){return ko.dataFor(n)}),r=ko.dataFor(t);r.ReportItemCollection(i)});var i=new $.Deferred,r=ko.mapping.toJSON(e.reportDefinition);return n.post(r,"/ReportDefinition/Save").then(function(n){t.log("RDL has been saved",r,this,!0);i.resolve(n)}),i.promise()},p=function(n,t){r.removeReportItem(n);$(t.target).parents(".report-item")},w=function(){var n=new $.Deferred;return setTimeout(function(){n.resolve(!0)},500),$("#rdl-configuration-panel").modal(),n.promise()},b=function(n){e.reportDefinition().DataSource().ParameterCollection.remove(n)},k=function(){e.reportDefinition().DataSource().ParameterCollection.push(new bespoke.sph.domain.Parameter)},d=function(n){n.ReportColumnCollection.push(new bespoke.sph.domain.ReportColumn)},g=function(){e.reportDefinition().DataSource().ReportFilterCollection.push(new bespoke.sph.domain.ReportFilter)},nt=function(n){e.reportDefinition().DataSource().ReportFilterCollection.remove(n)},tt=function(n){e.reportDefinition().DataSource().EntityFieldCollection.remove(n)},it=function(n,t){var i=ko.dataFor($(t.target).parents("table")[0]);i.ReportColumnCollection.remove(n)},rt=function(){return f.exportJson("report.definition."+e.reportDefinition().ReportDefinitionId()+".json",ko.mapping.toJSON(e.reportDefinition))},ut=function(){return f.importJson().done(function(i){try{var r=n.toObservable(JSON.parse(i));_(r.DataSource.ParameterCollection).each(function(n){n.DefaultValue||(n.DefaultValue="")});r.ReportDefinitionId(0);o(r.DataSource().EntityName());s(r)}catch(u){t.error("Fail template import tidak sah",u)}})},e={reportDefinition:r.reportDefinition,title:ko.observable("Report Builder"),isBusy:c,activate:a,viewAttached:v,removeReportItem:p,selectReportItem:r.selectReportItem,selectedReportItem:r.selectedReportItem,toolboxitems:r.toolboxItems,selectedEntityName:ko.observable(""),entityColumns:ko.observableArray(),filterableEntityColumns:ko.observableArray(),removeParameter:b,addParameter:k,addFilter:g,removeFilter:nt,removeField:tt,removeDataGridColumn:it,addDataGridColumn:d,dataGridColumnOptions:ko.observableArray(),columnOptions:ko.observableArray(),toolbar:{saveCommand:y,exportCommand:rt,importCommand:ut,commands:ko.observableArray([{command:w,caption:"Configuration",icon:"icon-gear"},{command:u.showPreview,caption:"Preview",icon:" icon-file-text-alt"}])}};return e.reportDefinition().DataSource().EntityName.subscribe(o),e});
//# sourceMappingURL=reportdefinition.edit.min.js.map