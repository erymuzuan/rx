@using Newtonsoft.Json
@model Bespoke.Sph.Web.Controllers.AdminController
@{
    ViewBag.Title = "UsersJs";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var roles = Roles.GetAllRoles();

}

<script type="text/javascript" data-script="true">
    define(['services/datacontext','viewmodels/_users.designation','viewmodels/_users.department','services/logger'], function (context,designationvm,departmentvm,logger) {
        var isBusy = ko.observable(false),
            roles = @Html.Raw(JsonConvert.SerializeObject(roles)),
            printprofile = ko.observable(new bespoke.sph.domain.Profile()),
            profiles = ko.observableArray(),
            activate = function() {
                var query = String.format("UserProfileId gt 0");
                var tcs = new $.Deferred();
                loadDetails();
                var profileTask = context.loadAsync("UserProfile", query);
                var designationTask = context.getListAsync("Designation","DesignationId gt 0", "Name");
                var departmentTask = context.loadOneAsync("Setting", "Key eq 'Departments'");
                $.when(designationTask,profileTask,departmentTask)
                 .then(function(s,p,d) {
                     isBusy(false);
                     if (s) {
                         vm.designationOptions(s);
                     }
                     if (d) {
                         var departments = JSON.parse(ko.mapping.toJS(d.Value));;
                         vm.departmentOptions(departments);
                     }
                     var list = _(p.itemCollection).map(map);
                     vm.profiles(list);

                     tcs.resolve(true);
                 });
                return tcs.promise();
            },
            map = function(item) {
                var profile = new bespoke.sph.domain.Profile();
                profile.IsNew(false);
                profile.FullName(item.FullName());
                profile.UserName(item.Username());
                profile.Email(item.Email());
                profile.Designation(item.Designation());
                profile.Department(item.Department());
                profile.Telephone(item.Telephone());
                return profile;
            },
            loadDetails = function() {
                designationvm.activate(roles);
                departmentvm.activate();
            },
            add = function() {
                vm.profile(new bespoke.sph.domain.Profile());
                vm.profile().IsNew(true);
                
                
                $('#user-details-modal').modal();
                return Task.fromResult(true);
            },
            editedProfile = ko.observable(),
            edit = function(user) {
                editedProfile(user);
                var c1 = ko.mapping.fromJSON(ko.mapping.toJSON(user));
                var clone = c1;
                vm.profile(clone);
            },
            save = function() {
                var tcs = new $.Deferred();
                var data = ko.mapping.toJSON({profile : vm.profile}) ;
                isBusy(true);

                context.post(data, "/Admin/AddUser")
                    .then(function(result) {
                        isBusy(false);
                        vm.profiles.push(result);
                        tcs.resolve(true);
                    });
                return tcs.promise();
            },
            resetPassword = function(user) {
                vm.password1('');
                vm.password2('');
                var c1 = ko.mapping.fromJSON(ko.mapping.toJSON(user));
                var clone = c1;
                vm.profile(clone);
            },
            savePassword = function(user) {
                var tcs = new $.Deferred();
                if (!vm.password1() && !vm.password2()) return tcs.promise();
                if (vm.password1() != vm.password2()) {
                    logger.logError('Password mismatch', user, this, true);
                    return tcs.promise();
                }
                
                var data = ko.mapping.toJSON({userName: vm.profile().UserName(), password: vm.password1}) ;
                isBusy(true);

                context.post(data, "/Admin/ResetPassword")
                    .then(function(result) {
                        isBusy(false);
                        if (result.OK) {
                            logger.info('Password of [' + vm.profile().UserName() + '] updated');
                        } else {
                            logger.logError(result.messages, user, this, true);
                        }
                        tcs.resolve(true);
                        
                    });
                return tcs.promise();
                
                
            };


        var vm = {
            activate: activate,
            isBusyValidatingUserName : ko.observable(false),
            profiles: profiles,
            profile: ko.observable(new bespoke.sph.domain.Profile()),
            printprofile : printprofile,
            designationOptions : ko.observableArray(),
            departmentOptions : ko.observableArray(),
            userNameValidationStatus : ko.observable(),
            addCommand: add,
            editCommand: edit,
            saveCommand: save,
            password1: ko.observable(),
            password2: ko.observable(),
            resetPasswordCommand: resetPassword,
            savePasswordCommand: savePassword,
            map: map,
            toolbar : ko.observable({
                reloadCommand: function () {
                    return activate();
                },
                printCommand: ko.observable({
                    entity: ko.observable("UserProfile"),
                    id: ko.observable(0),
                    item: printprofile,
                }),
                commands : ko.observableArray([
                    {
                        caption : "Tambah Pengguna",
                        icon : "icon-plus",
                        command : add
                    }])
            })
        };


        vm.profile().UserName.subscribe(function(username) {
            vm.isBusyValidatingUserName(true);
            var tcs = new $.Deferred();
            var data = JSON.stringify({userName : username});
            isBusy(true);
            context.post(data, "/Admin/ValidateUserName")
                .then(function(result) {
                    isBusy(false);
                    vm.isBusyValidatingUserName(false);
                    if (result.status !== "OK") {
                        vm.userNameValidationStatus(result.message);
                    }

                    tcs.resolve(result);
                });
            return tcs.promise();
        });

        return vm;
    });
</script>
