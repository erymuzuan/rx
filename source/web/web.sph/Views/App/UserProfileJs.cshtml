@using Newtonsoft.Json
@model Bespoke.Sph.Web.ViewModels.UserProfileViewModel
@{
    Layout = null;
}
<script type="text/javascript" data-script="true">

    define(['services/datacontext'],
        function (context) {


            var isBusy = ko.observable(false),
            username = ko.observable('@Model.User.UserName'),
            activate = function () {
                var query = String.format("Username eq '{0}'", username());
                var tcs = new $.Deferred();
                context.loadOneAsync("UserProfile", query)
                    .done(function (b) {
                        if (b)
                            vm.userProfile(b);
                        else
                            vm.userProfile(new bespoke.sph.domain.UserProfile());
                        tcs.resolve(true);
                    });

                return tcs.promise();
            },
            saveAsync = function () {
                var tcs = new $.Deferred();
                var data = ko.mapping.toJSON(vm.userProfile());
                context.post(data, "/Admin/UpdateUser")
                .done(function (e) {
                    tcs.resolve(e);
                });
                return tcs.promise();
            };

            var vm = {
                activate: activate,
                userProfile: ko.observable(new bespoke.sph.domain.UserProfile()),
                startModule: ko.observable('@Model.Profile.StartModule'),
                startModuleOptions : ko.observableArray(@Html.Raw(JsonConvert.SerializeObject(Model.StartModuleOptions))),
                toolbar: {
                    saveCommand: saveAsync
                },
                isBusy: isBusy,
                title: 'User profile Details'
            };

            return vm;
        });
</script>
