#pragma warning disable 1591
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.34014
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

namespace Bespoke.Sph.Web.Areas.App.Views.EntityFormDesigner
{
    using System;
    using System.Collections.Generic;
    using System.IO;
    using System.Linq;
    using System.Net;
    using System.Text;
    using System.Web;
    using System.Web.Helpers;
    using System.Web.Mvc;
    using System.Web.Mvc.Ajax;
    using System.Web.Mvc.Html;
    using System.Web.Routing;
    using System.Web.Security;
    using System.Web.UI;
    using System.Web.WebPages;
    
    #line 1 "..\..\Areas\App\Views\EntityFormDesigner\Script.cshtml"
    using Newtonsoft.Json;
    
    #line default
    #line hidden
    
    [System.CodeDom.Compiler.GeneratedCodeAttribute("RazorGenerator", "2.0.0.0")]
    [System.Web.WebPages.PageVirtualPathAttribute("~/Areas/App/Views/EntityFormDesigner/Script.cshtml")]
    public partial class Script : System.Web.Mvc.WebViewPage<Bespoke.Sph.Web.ViewModels.TemplateFormViewModel>
    {
        public Script()
        {
        }
        public override void Execute()
        {


WriteLiteral("\r\n");


            
            #line 4 "..\..\Areas\App\Views\EntityFormDesigner\Script.cshtml"
  
    Layout = null;
    var setting = new JsonSerializerSettings { TypeNameHandling = TypeNameHandling.All, Formatting = Formatting.Indented };


            
            #line default
            #line hidden
WriteLiteral(@"<script src=""~/SphApp/objectbuilders.js""></script>
<script src=""~/Scripts/knockout-3.1.0.debug.js""></script>
<script src=""~/Scripts/knockout.mapping-latest.debug.js""></script>
<script src=""~/SphApp/schemas/form.designer.g.js""></script>

<script type=""text/javascript"" data-script=""true"">

    define([objectbuilders.datacontext, objectbuilders.logger, objectbuilders.router, objectbuilders.system, objectbuilders.app, objectbuilders.eximp, objectbuilders.dialog],
        function (context, logger, router, system, app, eximp, dialog) {

            var errors = ko.observableArray(),
                operationsOption = ko.observableArray(),
                entity = ko.observable(new bespoke.sph.domain.EntityDefinition()),
                form = ko.observable(new bespoke.sph.domain.EntityForm({WebId:system.guid()})),
                activate = function (entityid, formid) {
                    var elements = ");


            
            #line 23 "..\..\Areas\App\Views\EntityFormDesigner\Script.cshtml"
                              Write(Html.Raw(JsonConvert.SerializeObject(Model.FormElements,setting)));

            
            #line default
            #line hidden
WriteLiteral(",\r\n                        oels = _(elements.$values).map(function (v){return con" +
"text.toObservable(v);});\r\n                    vm.formElements(oels);\r\n\r\n        " +
"            var fid = parseInt(formid),\r\n                        id = parseInt(e" +
"ntityid),\r\n                        query = String.format(\"EntityDefinitionId eq " +
"{0}\", id),\r\n                        tcs = new $.Deferred();\r\n\r\n                 " +
"   context.loadOneAsync(\"EntityDefinition\", query)\r\n                        .don" +
"e(function (b) {\r\n                            entity(b);\r\n                      " +
"      if (!fid) {\r\n                                tcs.resolve(true);\r\n         " +
"                   }\r\n                            var operations = (b.EntityOper" +
"ationCollection()).map(function(v) {\r\n                                return v.N" +
"ame();\r\n                            });\r\n                            operations." +
"push(\"save\");\r\n                            operationsOption(operations);\r\n      " +
"                      //b.loadSchema();\r\n                        });\r\n          " +
"          if (fid) {\r\n                        context.loadOneAsync(\"EntityForm\"," +
" \"EntityFormId eq \" + fid)\r\n                        .done(function(f) {\r\n       " +
"                     _(f.FormDesign().FormElementCollection()).each(function(v) " +
"{\r\n                                v.isSelected = ko.observable(false);\r\n       " +
"                     });\r\n                            form(f);\r\n                " +
"            tcs.resolve(true);\r\n                        });\r\n                   " +
" }\r\n                    form().Name.subscribe(function(v) {\r\n                   " +
"     if (!form().Route()) {\r\n                            form().Route(v.toLowerC" +
"ase().replace(/\\W+/g, \"-\"));\r\n                        }\r\n                    });" +
"\r\n                    form().EntityDefinitionId(id);\r\n\r\n                    retu" +
"rn tcs.promise();\r\n\r\n                },\r\n                attached = function(vie" +
"w) {\r\n\r\n                    var fd = ko.unwrap(form().FormDesign);\r\n\r\n          " +
"          var dropDown = function (e) {\r\n                        e.preventDefaul" +
"t();\r\n                        e.stopPropagation();\r\n\r\n                        va" +
"r button = $(this);\r\n                        button.parent().addClass(\"open\")\r\n " +
"                           .find(\"input:first\").focus()\r\n                       " +
"     .select();\r\n                    };\r\n\r\n                    // Fix input elem" +
"ent click problem\r\n                    $(view).on(\'click mouseup mousedown\', \'.d" +
"ropdown-menu input, .dropdown-menu label\',\r\n                        function (e)" +
" {\r\n                            e.stopPropagation();\r\n                        })" +
";\r\n                    $(\'#template-form-designer\').on(\'click\', \'button.dropdown" +
"-toggle\', dropDown);\r\n\r\n\r\n                    //toolbox item clicked\r\n          " +
"          $(\'#add-field\').on(\"click\", \'a\', function (e) {\r\n                     " +
"   e.preventDefault();\r\n                        _(fd.FormElementCollection()).ea" +
"ch(function (f) {\r\n                            f.isSelected(false);\r\n           " +
"             });\r\n\r\n                        // clone\r\n                        va" +
"r fe = ko.mapping.fromJS(ko.mapping.toJS(ko.dataFor(this)));\r\n                  " +
"      fe.isSelected = ko.observable(true);\r\n                        fe.Label(\"La" +
"bel \" + fd.FormElementCollection().length);\r\n                        fe.CssClass" +
"(\"\");\r\n                        fe.Visible(\"true\");\r\n                        fe.E" +
"nable(\"true\");\r\n                        fe.Size(\"input-large\");\r\n               " +
"         fe.ElementId(system.guid());\r\n\r\n                        fd.FormElementC" +
"ollection.push(fe);\r\n                        vm.selectedFormElement(fe);\r\n\r\n\r\n  " +
"                  });\r\n\r\n                    // kendoEditor\r\n                   " +
" $(\'#template-form-designer\').on(\'click\', \'textarea\', function () {\r\n           " +
"             var $editor = $(this),\r\n                            kendoEditor = $" +
"editor.data(\"kendoEditor\");\r\n                        if (!kendoEditor) {\r\n      " +
"                      var htmlElement = ko.dataFor(this),\r\n                     " +
"           editor = $editor.kendoEditor({\r\n                                    c" +
"hange:function() {\r\n                                        htmlElement.Text(thi" +
"s.value());\r\n                                    }\r\n                            " +
"    }).data(\"kendoEditor\");\r\n\r\n                            htmlElement.Text.subs" +
"cribe(function(t) {\r\n                                editor.value(ko.unwrap(t));" +
"\r\n                            });\r\n\r\n                        }\r\n                " +
"    }\r\n                    );\r\n\r\n\r\n                    var receive = function (e" +
"vt, ui) {\r\n                        var elements = _($(\'#template-form-designer>f" +
"orm>div\')).map(function (div) {\r\n                            return ko.dataFor(d" +
"iv);\r\n                        }),\r\n                        fe = ko.dataFor(ui.it" +
"em[0]),\r\n                        sortable = $(this),\r\n                        po" +
"sition = 0,\r\n                        children = sortable.children();\r\n\r\n        " +
"                fe.isSelected = ko.observable(true);\r\n                        fe" +
".Enable(\"true\");\r\n                        fe.Visible(\"true\");\r\n\r\n               " +
"         for (var i = 0; i < children.length; i++) {\r\n                          " +
"  if ($(children[i]).position().top > ui.position.top) {\r\n                      " +
"          position = i;\r\n                                break;\r\n               " +
"             }\r\n                        }\r\n                        elements.spli" +
"ce(position, 0, fe);\r\n                        $(\'#template-form-designer>form\')." +
"sortable(\"destroy\");\r\n                        //rebuild\r\n                       " +
" fd.FormElementCollection(elements);\r\n                        initDesigner();\r\n " +
"                       $(\'#template-form-designer>form li.ui-draggable\').remove(" +
");\r\n                    },\r\n                        initDesigner = function () {" +
"\r\n                            $(\'#template-form-designer>form\').sortable({\r\n    " +
"                            items: \'>div\',\r\n                                plac" +
"eholder: \'ph\',\r\n                                helper: \'original\',\r\n           " +
"                     dropOnEmpty: true,\r\n                                forcePl" +
"aceholderSize: true,\r\n                                forceHelperSize: false,\r\n " +
"                               receive: receive\r\n                            });" +
"\r\n                        };\r\n\r\n                    initDesigner();\r\n           " +
"         $(\'#add-field>ul>li\').draggable({\r\n                        helper: \'clo" +
"ne\',\r\n                        connectToSortable: \"#template-form-designer>form\"\r" +
"\n                    });\r\n\r\n\r\n                    $(\'section.context-action-pane" +
"l\').on(\'click\', \'buton.close\', function() {\r\n                        $(this).par" +
"ents(\'div.context-action\').hide();\r\n                    });\r\n                },\r" +
"\n                supportsHtml5Storage = function () {\r\n                    try {" +
"\r\n                        return \'localStorage\' in window && window[\'localStorag" +
"e\'] !== null;\r\n                    } catch (e) {\r\n                        return" +
" false;\r\n                    }\r\n                },\r\n                okClick = fu" +
"nction (data, ev) {\r\n                    if (bespoke.utils.form.checkValidity(ev" +
".target)) {\r\n\r\n                        var fd = ko.unwrap(form().FormDesign);\r\n " +
"                       // get the sorted element\r\n                        var el" +
"ements = _($(\'#template-form-designer>form>div\')).map(function (div) {\r\n        " +
"                    return ko.dataFor(div);\r\n                        });\r\n      " +
"                  fd.FormElementCollection(elements);\r\n                        d" +
"ialog.close(this, \"OK\");\r\n                        if (supportsHtml5Storage()) {\r" +
"\n                            localStorage.removeItem(form().WebId());\r\n         " +
"               }\r\n                    }\r\n                },\r\n                can" +
"celClick = function () {\r\n                    if (supportsHtml5Storage()) {\r\n   " +
"                     localStorage.removeItem(form().WebId());\r\n                 " +
"   }\r\n                    dialog.close(this, \"Cancel\");\r\n                },\r\n   " +
"             selectFormElement = function (fe) {\r\n\r\n                    $(\'.sele" +
"cted-form-element\').each(function(e) {\r\n                        var kd = ko.data" +
"For(this);\r\n                        if (typeof kd.isSelected === \"function\")\r\n  " +
"                          kd.isSelected(false);\r\n                    });\r\n\r\n    " +
"                if (typeof fe.isSelected === \"undefined\") {\r\n                   " +
"     fe.isSelected = ko.observable(true);\r\n                    }\r\n              " +
"      fe.isSelected(true);\r\n                    vm.selectedFormElement(fe);\r\n   " +
"                 if (supportsHtml5Storage()) {\r\n                        localSto" +
"rage.setItem(form().WebId(), ko.mapping.toJSON(form));\r\n                    }\r\n " +
"               },\r\n                removeFormElement = function (fe) {\r\n        " +
"            var fd = ko.unwrap(form().FormDesign);\r\n                    fd.FormE" +
"lementCollection.remove(fe);\r\n                },\r\n                importCommand " +
"= function() {\r\n                    return eximp.importJson()\r\n                 " +
".done(function (json) {\r\n                     try {\r\n\r\n                         " +
"var obj = JSON.parse(json),\r\n                             clone = context.toObse" +
"rvable(obj);\r\n\r\n                         form().FormDesign(clone.FormDesign());\r" +
"\n\r\n                     } catch (error) {\r\n                         logger.logEr" +
"ror(\'Fail template import tidak sah\', error, this, true);\r\n                     " +
"}\r\n                 });\r\n                },\r\n                publish = function(" +
") {\r\n                    var fd = ko.unwrap(form().FormDesign);\r\n               " +
"     // get the sorted element\r\n                    var elements = _($(\'#templat" +
"e-form-designer>form>div\')).map(function (div) {\r\n                        return" +
" ko.dataFor(div);\r\n                    });\r\n                    fd.FormElementCo" +
"llection(elements);\r\n\r\n\r\n                    var tcs = new $.Deferred(),\r\n      " +
"                  data = ko.mapping.toJSON(form);\r\n\r\n                    context" +
".post(data, \"/Sph/EntityForm/Publish\")\r\n                        .then(function(r" +
"esult) {\r\n                            if (result.success) {\r\n                   " +
"             logger.info(result.message);\r\n                                entit" +
"y().EntityDefinitionId(result.id);\r\n                                errors.remov" +
"eAll();\r\n                            } else {\r\n                                e" +
"rrors(result.Errors);\r\n                                logger.error(\"There are e" +
"rrors in your entity, !!!\");\r\n                            }\r\n                   " +
"         tcs.resolve(result);\r\n                        });\r\n                    " +
"return tcs.promise();\r\n\r\n                },\r\n                save = function() {" +
"\r\n                    var fd = ko.unwrap(form().FormDesign);\r\n                  " +
"  // get the sorted element\r\n                    var elements = _($(\'#template-f" +
"orm-designer>form>div\')).map(function (div) {\r\n                        return ko" +
".dataFor(div);\r\n                    });\r\n                    fd.FormElementColle" +
"ction(elements);\r\n\r\n\r\n                    var tcs = new $.Deferred(),\r\n         " +
"               data = ko.mapping.toJSON(form);\r\n\r\n                    context.po" +
"st(data, \"/Sph/EntityForm/Save\")\r\n                        .then(function(result)" +
" {\r\n                            form().EntityFormId(result.id);\r\n               " +
"             tcs.resolve(result);\r\n                        });\r\n                " +
"    return tcs.promise();\r\n                },\r\n\r\n            depublishAsync = fu" +
"nction () {\r\n\r\n                var tcs = new $.Deferred(),\r\n                    " +
"data = ko.mapping.toJSON(form);\r\n\r\n                context.post(data, \"/EntityFo" +
"rm/Depublish\")\r\n                    .then(function (result) {\r\n                 " +
"       if (result.success) {\r\n                            logger.info(result.mes" +
"sage);\r\n                            errors.removeAll();\r\n                       " +
" } else {\r\n                            var views = _(result.views).map(function(" +
"v) {\r\n                                return {\r\n                                " +
"    Message : v + \" view has a link to this form!\",\r\n                           " +
"         Code : \"\"\r\n                                }\r\n                         " +
"   });\r\n                            errors(views);\r\n                            " +
"logger.error(\"There are errors in your form, depublish those views first to proc" +
"eed, !!!\");\r\n                        }\r\n                        tcs.resolve(resu" +
"lt);\r\n                    });\r\n                return tcs.promise();\r\n          " +
"  };\r\n\r\n            var vm = {\r\n                errors: errors,\r\n               " +
" operationsOption: operationsOption,\r\n                attached: attached,\r\n     " +
"           activate: activate,\r\n                formElements: ko.observableArray" +
"(),\r\n                selectedFormElement: ko.observable(),\r\n                sele" +
"ctFormElement : selectFormElement,\r\n                removeFormElement : removeFo" +
"rmElement,\r\n                form: form,\r\n                entity : entity,\r\n     " +
"           okClick: okClick,\r\n                cancelClick: cancelClick,\r\n       " +
"         importCommand :importCommand,\r\n                toolbar : {\r\n           " +
"         commands :ko.observableArray([{\r\n                        caption: \'Clon" +
"e\',\r\n                        icon: \'fa fa-copy\',\r\n                        comman" +
"d: function () {\r\n                            form().Name(form().Name() + \' Copy" +
" (1)\');\r\n                            form().Route(\'\');\r\n                        " +
"    form().EntityFormId(0);\r\n                            return Task.fromResult(" +
"0);\r\n                        }\r\n                    },\r\n                    {\r\n " +
"                       caption : \'Publish\',\r\n                        icon : \'fa " +
"fa-sign-in\',\r\n                        command : publish,\r\n                      " +
"  enable : ko.computed(function() {\r\n                            return form().E" +
"ntityFormId() > 0;\r\n                        })\r\n                    },\r\n        " +
"            {\r\n                        command: depublishAsync,\r\n               " +
"         caption: \'Depublish\',\r\n                        icon: \"fa fa-sign-out\",\r" +
"\n                        enable: ko.computed(function () {\r\n                    " +
"        return form().EntityFormId() > 0 && form().IsPublished();\r\n             " +
"           })\r\n                    }\r\n                    ]),\r\n                 " +
"   saveCommand : save\r\n                }\r\n            };\r\n\r\n            return v" +
"m;\r\n\r\n        });\r\n\r\n\r\n</script>\r\n");


        }
    }
}
#pragma warning restore 1591
